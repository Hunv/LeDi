@page "/tournamentplanning"
@using LeDi.Server2.DatabaseModel;
@using Microsoft.AspNetCore.Authorization;
@using Microsoft.AspNetCore.Identity;
@inject UserManager<IdentityUser> _UserManager
@inject RoleManager<IdentityRole> _RoleManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager
@inject Microsoft.Extensions.Localization.IStringLocalizer<TournamentPlanning> Localizer

<h3>@Localizer["TournamentPlanning"]</h3>


@if (TournamentList == null)
{
    <p><em>@Localizer["Loading"]</em></p>
}
else
{
    <AuthorizeView Roles="Att-CanTournamentAdd,Att-CanTournamentEdit,Att-CanTournamentMatchAdd,Att-CanTournamentMatchDelete,Att-CanTournamentMatchDelete,Att-IsAdmin">
        <Authorized>
            <br />
            <h4>@Localizer["CurrentOrPlanedTournaments"]</h4>

            <div class="container-fluid">
                @if (TournamentList == null || TournamentList.Count == 0)
                {
                    <h6>-@Localizer["None"]-</h6> 
                }
                else
                {
                    @foreach (var tournament in TournamentList.Where(x => x.EndDate >= DateTime.Today).OrderBy(x => x.StartDate))
                {
                    <Card>
                        <HeaderTemplate>
                            <h5>@tournament.Name</h5>
                        </HeaderTemplate>
                        <BodyTemplate>
                            <a href="/tournamentmatchlist/@tournament.Id" class="fs-5 btn btn-primary"><i class="fas fa-arrow-right" aria-hidden="true"></i> @Localizer["GoToMatchlist"]</a><br /><br />

                            <table class="table table-borderless table-sm">
                                <tbody>
                                    <tr>
                                        <td>
                                            @Localizer["TournamentStartDate"]
                                        </td>
                                        <td>
                                            @tournament.StartDate
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            @Localizer["TournamentEndDate"]
                                        </td>
                                        <td>
                                            @tournament.EndDate
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            @Localizer["Template"]
                                        </td>
                                        <td>
                                            @if (@tournament.Template == null)
                                            {
                                                @Localizer["None"]
                                            }
                                            else
                                            {
                                                @tournament.Template.TemplateName
                                            }
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            @Localizer["NumberOfMatches"]
                                        </td>
                                        <td>
                                            @tournament.Matches.Count()
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            @Localizer["Teams"]
                                        </td>
                                        <td>
                                            Number: todo <br />
                                            Participating Teams: todo
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </BodyTemplate>
                        <FooterTemplate>
                            <div class="span">
                                <AuthorizeView Roles="Att-CanTournamentMatchAdd,Att-IsAdmin" Context="y">
                                    <Authorized>
                                        <Tooltip Title="@Localizer["AddMatch"]" Placement="Placement.Bottom">
                                            <a href="/matchadd?tournamentid=@tournament.Id&returnurl=/tournamentplanning" class="fs-4 btn btn-primary m-2" style="width:96px">
                                                    <i class="fa-solid fa-plus" aria-hidden="true"></i>
                                                </a>
                                        </Tooltip>
                                    </Authorized>
                                </AuthorizeView>
                                @if (EventTournamentId != tournament.Id.ToString())
                                {
                                    <AuthorizeView Roles="Att-CanTournamentAdd,Att-IsAdmin" Context="y">
                                        <Authorized>
                                            <Tooltip Title="@Localizer["StartTournament"]" Placement="Placement.Bottom" @onclick="@(() => StartTournament(tournament.Id))">
                                                <a class="fs-4 btn btn-primary m-2" style="width:96px">
                                                    <i class="fa-solid fa-play" aria-hidden="true"></i>
                                                </a>
                                            </Tooltip>
                                        </Authorized>
                                    </AuthorizeView>
                                }
                                else
                                {
                                    <AuthorizeView Roles="Att-CanTournamentAdd,Att-IsAdmin" Context="y">
                                        <Authorized>
                                            <Tooltip Title="@Localizer["StopTournament"]" Placement="Placement.Bottom" @onclick="StopTournament">
                                                <a style="width:96px" class="fs-4 btn btn-primary m-2">
                                                    <i class="fa-solid fa-stop" aria-hidden="true"></i>
                                                </a>
                                            </Tooltip>
                                        </Authorized>
                                    </AuthorizeView>
                                }
                                <AuthorizeView Roles="Att-CanTournamentEdit,Att-IsAdmin" Context="y">
                                    <Authorized>
                                        <Tooltip Title="@Localizer["Edit"]" Placement="Placement.Bottom">
                                            <a href="/tournamentadd/@tournament.Id" class="fs-4 btn btn-primary m-2" style="width:96px">
                                                <i class="fa-solid fa-pencil" aria-hidden="true"></i>
                                            </a>
                                        </Tooltip>
                                    </Authorized>
                                </AuthorizeView>
                            </div>
                        </FooterTemplate>
                    </Card>
                    <br />
                }
                }
            </div>

            <AuthorizeView Roles="Att-CanTournamentAdd,Att-IsAdmin" Context="y">
                <Authorized>
                    <br />
                    <a class="fs-5 btn btn-primary" href="tournamentadd" role="button"><i class="fa-solid fa-circle-plus" aria-hidden="true"/> @Localizer["CreateTournament"]</a>
                </Authorized>
            </AuthorizeView>

            <br /> <br /> <br />

            <h4>@Localizer["FinishedTournaments"]</h4>
            <table class="table">
                <thead>
                    <tr>
                        <th>@Localizer["TournamentName"]</th>
                        <th>@Localizer["TournamentStartDate"]</th>
                        <th>@Localizer["TournamentEndDate"]</th>
                        <th>@Localizer["NumberOfTeams"]</th>
                        <th>@Localizer["NumberOfMatches"]</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var tournament in TournamentList)
                    {
                        <tr>
                            <td>
                                @tournament.Name
                            </td>
                            <td>
                                @tournament.StartDate
                            </td>
                            <td>
                                @tournament.EndDate
                            </td>
                            <td>todo</td>
                            <td>@tournament.Matches.Count()</td>
                            <td></td>
                        </tr>
                    }
                </tbody>
            </table>
        </Authorized>
        <NotAuthorized>
            <p>@Localizer["NoPermissions"]</p>
        </NotAuthorized>
    </AuthorizeView>
}