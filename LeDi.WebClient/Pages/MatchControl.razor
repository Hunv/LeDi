@page "/matchcontrol"
@page "/matchcontrol/{SelectedMatchId:int}"
@inject LeDi.Shared.Api Api
@inject NavigationManager NavigationManager
@using LeDi.Shared
@using LeDi.Shared.DtoModel
@using LeDi.Shared.Enum
@using LeDi.WebClient.Components
@inject Microsoft.Extensions.Localization.IStringLocalizer<MatchControl> Localizer

<PageTitle>LeDi - @Localizer["PageTitle"]</PageTitle>
@if (MatchList == null && SelectedMatchId == null)
{
    <p><em>@Localizer["LoadingMatches"]</em></p>
}
else if (SelectedMatchId == null && MatchList != null && MatchList.Count == 0)
{
    <p><em>Currently no matches running.</em></p>
}
else if (SelectedMatchId == null && MatchList != null)
{
    @*Select the Match to referee about*@
    <div class="container-fluid">
        @foreach(var aMatch in MatchList)
        {
            <div class="row">
                <div class="col-12">
                    @if (aMatch.MatchStatus == (int)MatchStatusEnum.Running)
                    {
                        <a class="btn btn-success fs-3" style="display:block; width:100%;" href="/matchcontrol/@aMatch.Id">@aMatch.ScheduledTime - @aMatch.Team1Name @Localizer["vs"] @aMatch.Team2Name</a>
                    }
                    else if (aMatch.MatchStatus == (int)MatchStatusEnum.Ended)
                    {
                        <a class="btn btn-secondary fs-3" style="display:block; width:100%;" href="/matchcontrol/@aMatch.Id">@aMatch.ScheduledTime - @aMatch.Team1Name @Localizer["vs"] @aMatch.Team2Name</a>
                    }
                    else if (aMatch.MatchStatus == (int)MatchStatusEnum.ReadyToStart)
                    {
                        <a class="btn btn-primary fs-3" style="display:block; width:100%;" href="/matchcontrol/@aMatch.Id">@aMatch.ScheduledTime - @aMatch.Team1Name @Localizer["vs"] @aMatch.Team2Name</a>
                    }
                    else {
                        <a class="btn btn-outline-dark fs-3" style="display:block; width:100%;" href="/matchcontrol/@aMatch.Id">@aMatch.ScheduledTime - @aMatch.Team1Name @Localizer["vs"] @aMatch.Team2Name</a>
                    }
                    <br />
                </div>
            </div>
        }    
        <a>@Localizer["Legend"]</a>
    </div>
}
else if (SelectedMatchId != null)
{
    @if (Match == null)
    {
        <p><em>@Localizer["LoadingMatch"]</em></p>
    }
    else
    {
        <div class="container-fluid h-100" style="height:90vh; min-height:90vh; flex-grow:1;">
            @*Row 1: Time, Scores*@
            <div class="row align-items-start" style="height:20vh; min-height:20vh;">
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <div>
                            <a class="fs-2 text-decoration-none text-reset" style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Match.Team1Name</a> 
                            <a class="text-decoration-none text-reset fw-bold" style="font-size:8vh; display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Match.Team1Score</a>
                        </div>
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <div>
                            @if(Match.MatchStatus == (int)MatchStatusEnum.Canceled)
                            {
                                <a class="text-decoration-none fw-bolder text-danger" style="font-size:6vh; display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;"><br />@Localizer["Canceled"]</a>
                            }
                            else if(Match.MatchStatus == (int)MatchStatusEnum.Ended || Match.MatchStatus == (int)MatchStatusEnum.Closed)
                            {
                                <a class="text-decoration-none fw-bolder text-reset" style="font-size:6vh; display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;"><br />@Localizer["MatchEnded"]</a>
                            }
                            else 
                            {
                                <a class="text-decoration-none fw-bolder text-reset" style="font-size:8vh; display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@(Match.TimeLeftSeconds / 60):@(((Match.TimeLeftSeconds ?? 0) % 60).ToString().PadLeft(2,'0'))</a>
                                <a class="fs-3 text-decoration-none text-reset" style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Localizer["Period"]</a>
                                <a class="fs-3 text-decoration-none text-reset" style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Match.PeriodCurrent of @Match.RulePeriodCount</a>
                            }
                        </div>
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <div>
                            <a class="fs-2 text-decoration-none text-reset" style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Match.Team2Name</a>                            
                            <a class="text-decoration-none text-reset fw-bold" style="font-size:8vh; display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;">@Match.Team2Score</a>
                        </div>
                    </div>
                </div>
            </div>

            @*Row 2: Penalties*@
            <div class="row align-items-start" style="height:15vh; min-height:10vh;">
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <a 
                            id="btnPenaltyTeam1"
                            class="btn btn-danger fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:20%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@PenaltyTeam1Clicked"                            
                            >
                            @Localizer["LogPenalty"]
                        </a>
                        <a class="text-decoration-none text-reset fs-4 text-nowrap text-truncate">
                            <div class="container">                                
                                @foreach(var aPenalty in Match.Penalties.Where(x => x.TeamId == 0))
                                {
                                    if (aPenalty.PenaltyTime > 0)
                                    {
                                        var timeleft = Match.TimeLeftSeconds - (Match.RulePeriodLength - aPenalty.PenaltyTimeStart - aPenalty.PenaltyTime) - ((Match.RulePeriodLength ?? 0) * (Match.PeriodCurrent -1)) ;

                                        if (timeleft >= -10) // To show the 0:00 some seconds after the penalty is over.
                                        {
                                            if (timeleft < 0)
                                                timeleft = 0;

                                            <div class="row">
                                                <div class="col-2">
                                                    @((timeleft / 60).ToString() + ":" + (timeleft.Value % 60).ToString().PadLeft(2,'0'))
                                                </div>
                                                <div class="col-10">
                                                    Player #@aPenalty.PlayerNumber (@aPenalty.PenaltyName)
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        </a>
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <a 
                            id="btnPenaltyTeam2"
                            class="btn btn-danger fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:20%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@PenaltyTeam2Clicked"
                            >
                            @Localizer["LogPenalty"]
                        </a>                        
                        <a class="text-decoration-none text-reset fs-4 text-nowrap text-truncate">
                            <div class="container">                                
                                @foreach(var aPenalty in Match.Penalties.Where(x => x.TeamId == 1))
                                {
                                    if (aPenalty.PenaltyTime > 0)
                                    {
                                        var timeleft = Match.TimeLeftSeconds - (Match.RulePeriodLength - aPenalty.PenaltyTimeStart - aPenalty.PenaltyTime) - ((Match.RulePeriodLength ?? 0) * (Match.PeriodCurrent -1)) ;

                                        if (timeleft >= -10) // To show the 0:00 some seconds after the penalty is over.
                                        {
                                            if (timeleft < 0)
                                                timeleft = 0;

                                            <div class="row">
                                                <div class="col-2">
                                                    @((timeleft / 60).ToString() + ":" + (timeleft.Value % 60).ToString().PadLeft(2,'0'))
                                                </div>
                                                <div class="col-10">
                                                    Player #@aPenalty.PlayerNumber (@aPenalty.PenaltyName)
                                                </div>
                                            </div>
                                        }
                                    }
                                }
                            </div>
                        </a>
                    </div>
                </div>
            </div>

            @*Row 3: Controls*@
            <div class="row align-items-start" style="height:30vh; min-height:30vh;">
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <a 
                            id="btnScoreTeam1"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:76%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@IncrementCountTeam1Clicked"
                            >
                            @Localizer["Score"]
                        </a>                        
                        <a 
                            style="display:block; width:100%; min-height:4%; display:flex; align-items:center; justify-content:center;">
                        </a>
                        <a 
                            id="btnRevokeTeam1"
                            class="btn btn-secondary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:20%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@DecreaseCountTeam1Clicked"
                            >
                            @Localizer["RevokeScore"]
                        </a>
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <a 
                            id="btnStart"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:48%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchStartClicked"
                            disabled="@ButtonDisableStart" 
                            hidden="@(!ButtonPreparePeriodDisabled || !ButtonCloseMatchDisabled)"
                            >
                            @Localizer["Start/Continue"]
                        </a>                        
                        <a 
                            style="display:block; width:100%; min-height:4%; display:flex; align-items:center; justify-content:center;"
                            disabled="@ButtonDisableStart" 
                            hidden="@(!ButtonPreparePeriodDisabled || !ButtonCloseMatchDisabled)"
                            >
                        </a>
                        <a 
                            id="btnPause"
                            class="btn btn-outline-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:48%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchPauseClicked"
                            disabled="@ButtonDisableStart" 
                            hidden="@(!ButtonPreparePeriodDisabled || !ButtonCloseMatchDisabled)"
                            >
                            @Localizer["Pause"]
                        </a>

                        <a 
                            id="btnPreparePeriod"
                            class="btn btn-secondary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchPreparePeriodClicked"
                            disabled="@ButtonPreparePeriodDisabled" 
                            hidden="@ButtonPreparePeriodDisabled"
                            >
                            @Localizer["PrepareNextPeriod"]
                        </a>

                        <a 
                            id="btnCloseMatch"
                            class="btn btn-dark fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchCloseClicked"
                            disabled="@ButtonCloseMatchDisabled" 
                            hidden="@ButtonCloseMatchDisabled"
                            >
                            @Localizer["CloseMatch"]
                        </a>
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">                                                
                        <a 
                            id="btnScoreTeam2"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:76%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@IncrementCountTeam2Clicked"
                            >
                            @Localizer["Score"]
                        </a>
                        <a 
                            style="display:block; width:100%; min-height:4%; display:flex; align-items:center; justify-content:center;">
                        </a>
                        <a 
                            id="btnRevokeTeam2"
                            class="btn btn-secondary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; min-height:20%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@DecreaseCountTeam2Clicked"
                            >
                            @Localizer["RevokeScore"]
                        </a>
                    </div>
                </div>
            </div>

            @*Row 3a: Advanced controls*@
            <div class="row align-items-start pt-5">
                 <div class="col-12 p-0 m-0">
                    <div class="p-1">          
                        <a 
                            id="btnAdvancedControlsExpand"
                            class="btn btn-primary fs-3" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@ExpandAdvancedControls"
                            >
                            <span class="oi @(this.HideAdvancedControls ? "oi-arrow-circle-bottom" : "oi-arrow-circle-top")" /> @(this.HideAdvancedControls ? Localizer["ShowControls"] : Localizer["HideControls"])
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="row align-items-start @(ButtonAllDisabled ? "disabled": "")" hidden="@HideAdvancedControls">
                 <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">                        
                        <a 
                            id="btnCancelMatch"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchCancelClicked"
                            >
                            @Localizer["CancelMatch"]
                        </a>  
                    </div>
                    <div style="height:100%; min-height:100%;" class="p-1">                        
                        <a 
                            id="btnRestartMatch"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchRestartClicked"
                            >
                            @Localizer["RestartMatch"]
                        </a>  
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">                        
                        <a 
                            id="btnSetTime"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@MatchSetTimeClicked"
                            >
                            @Localizer["SetMatchTime"]
                        </a>  
                    </div>
                    <div style="height:100%; min-height:100%;" class="p-1">                        
                        <a 
                            id="btnSetDisplay"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@SetDisplayClicked"
                            >
                            @Localizer["ShowOnDisplay"]
                        </a>  
                    </div>
                </div>
                <div class="col-4 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">                        
                        <a 
                            id="btnRevokePenalty"
                            class="btn btn-primary fs-3 @(ButtonAllDisabled ? "disabled": "")" 
                            style="display:block; width:100%; display:flex; align-items:center; justify-content:center;" 
                            role="button" 
                            @onclick="@RevokePenaltyClicked"
                            >
                            @Localizer["RevokePenalty"]
                        </a>  
                    </div>
                </div>
            </div>

            @*Row 4: Matchlog*@            
            <div class="row align-items-start" style="height:30vh; min-height:30vh;">
                <div class="col-12 p-0 m-0" style="height:100%; min-height:100%;">
                    <div style="height:100%; min-height:100%;" class="p-1">
                        <a class="fs-2 text-decoration-none text-reset">Match log:</a><br />
                        @if(MatchEventList == null) 
                        {
                            <a>@Localizer["NoMatchEventsAvailable"]</a>

                            <br />
                        }
                        else
                        {
                            <div class="container-fluid">
                                <div class="row">
                                    @*<div class="col-1 text-nowrap">
                                        <b>#</b>
                                    </div>*@
                                    <div class="col-1 text-nowrap">
                                        <b>@Localizer["Time"]</b>
                                    </div>@*
                                    <div class="col-1 text-nowrap">
                                        <b>Creator</b>
                                    </div>*@
                                    <div class="col-auto">
                                        <b>@Localizer["Note"]</b>
                                    </div>
                                </div>
         
                                @foreach(var aEvent in MatchEventList.Reverse<DtoMatchEvent>())
                                {
                                    <div class="row justify-content-start">                    
                                        @*<div class="col-1 text-nowrap">
                                            @aEvent.Event
                                        </div>*@
                                        <div class="col-1 text-nowrap">
                                            @(aEvent.Matchtime/60):@((aEvent.Matchtime%60).ToString().PadLeft(2,'0'))
                                        </div>@*
                                        <div class="col-1 text-nowrap">
                                            @(aEvent.Source ?? "System")
                                        </div>*@
                                        <div class="col-auto">
                                            @aEvent.Text
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <p><em>@Localizer["UnableToLoadMatch"]</em></p>
}

@if (DialogPenaltyPlayerShow)
{
    <ModalPlayernumberDialog 
        Title="@Localizer["SelectPlayernumber"]"
        Text="@Localizer["SelectPlayernumberAppliesTo"]"
        PlayerNumbers=@PenaltyPlayerNumbers
        OnClose="@OnPenaltyPlayerClose"
        ShowTeamButton=true
        >
    </ModalPlayernumberDialog>
}

@if (DialogPenaltyPenaltyShow)
{
    <ModalPenaltyDialog 
        Title="@Localizer["SelectPenalty"]"
        Text="@Localizer["SelectPenaltyPlayer."]"
        PenaltyList=@PenaltyList
        OnClose="@OnPenaltyPenaltyClose"
        >
    </ModalPenaltyDialog>
}

@if (DialogYesNoDangerShow)
{
    <ModalDialog
        Title="@Localizer["AreYouSure"]"
        Text="@Localizer["PerfomThatAction"]"
        OnClose="@OnYesNoClose"
        ButtonOKText="Yes"
        ButtonCancelText="No"
        ButtonOKClass="btn-danger"
        >
    </ModalDialog>
}

@if (DialogTimeShow)
{
    <ModalTimeDialog 
        Title="@Localizer["MatchTimeLeft"]"
        Text="@Localizer["SetMatchTimeLeft"]"
        OnClose="@OnTimeClose"
        DefaultTimeSeconds="@(Match == null ? 600 : (Match.RulePeriodLength ?? 600))"        
        TimeLeftSeconds="@(Match == null ? 0 : (Match.TimeLeftSeconds ?? 0))"
        >
    </ModalTimeDialog>
}

@if (DialogPenaltyRevokeShow)
{
    <ModalPenaltyRevokeDialog 
        Title="@Localizer["PenaltyRevoke"]"
        Text="@Localizer["WhichPenaltyRevoke"]"
        OnClose="@OnPenaltyRevokeClose"
        PenaltyList="@(Match == null ? new List<DtoMatchPenalty>() : Match.Penalties.Where(x => x.Revoked == false).ToList())"
        >
    </ModalPenaltyRevokeDialog>
}


@if (DialogDeviceShow)
{
    <ModalDisplayDialog 
        Title="@Localizer["SelectDevice"]"
        Text="@Localizer["WhichDevice"]"
        OnClose="@OnDisplayClose"
        Devices="@DeviceList"
        >
    </ModalDisplayDialog>
}

@code{
    private readonly NLog.Logger Logger = NLog.LogManager.GetCurrentClassLogger();
    System.Timers.Timer tmrMatchtime = new System.Timers.Timer();
    DtoMatch Match = new DtoMatch(); // currently selected match
    List<DtoMatchEvent>? MatchEventList = null; //List of all match events
    List<DtoMatch>? MatchList = null; // List of all not finished matches
    bool ButtonDisableStart = false; //Is the Start button disabled?
    bool ButtonPreparePeriodDisabled = true; //Is the Prepare period button disabled?
    bool ButtonCloseMatchDisabled = true; //The close button is disabled and invisible?
    bool ButtonAllDisabled = false; //All buttons are disabled (i.e. when match ended or canceled.)
    bool HideAdvancedControls = true; //Are the advanced control buttons visible?
    int LastKnownMatchHash = 0; // Contains a hash of all match values, that can change (except time).
    bool tmrMatchtimeElapsedRegistered = false; //Is the Elapsed Event of tmrMatchtime already registered?
    string DialogYesNoDangerAction = ""; //This defines what should be executed, after the danger dialog closes.
    bool DialogYesNoDangerShow = false; //Is the modal dialog for a yes/no question shown?
    bool DialogPenaltyPlayerShow = false; // Is the modal dialog for playernumber for penalties of team 1 opened?
    bool DialogPenaltyPenaltyShow = false; //Is the modal dialog for the penalty for penalties of team 1 opened?
    bool DialogTimeShow = false; //Is the modal dialog for setting the time opened?
    bool DialogPenaltyRevokeShow = false; //Is the modal dialog for revoke penalty opened?
    bool DialogDeviceShow = false; //Is the modal dialog for device selection opened?
    int PenaltyTeamId = -1; //The ID (0 = Team 1, 1 = Team 2) of the team the currently selecting penalty is for.
    int PenaltyPlayerNumber = -1; //The Playernumber that get the penalty
    List<int> PenaltyPlayerNumbers = new List<int>(); // The playernumbers of a team. Null or empty in case the number should be entered in the modal dialog.
    List<string> PenaltyList = new List<string>(); // The list of penalties the referee can choose for the previously selected player (or team)
    List<DtoDevice>DeviceList = new List<DtoDevice>(); //The list of devices. Only filled when the Set-Display button was clicked.

    [Parameter]
    public int? SelectedMatchId { get; set; }

    private async void IncrementCountTeam1Clicked()
    {
        Logger.Trace("IncrementCountTeam1Clicked.");
        await Api.SetMatchGoalAsync(Match.Id, 0, 1);
        await LoadMatch();
    }
    private async void DecreaseCountTeam1Clicked()
    {
        Logger.Trace("DecreaseCountTeam1Clicked.");
        await Api.SetMatchGoalAsync(Match.Id, 0, -1);
        await LoadMatch();
    }

    private async void IncrementCountTeam2Clicked()
    {
        Logger.Trace("IncrementCountTeam2Clicked.");
        await Api.SetMatchGoalAsync(Match.Id, 1, 1);
        await LoadMatch();
    }
    private async void DecreaseCountTeam2Clicked()
    {
        Logger.Trace("DecreaseCountTeam2Clicked.");
        await Api.SetMatchGoalAsync(Match.Id, 1, -1);
        await LoadMatch();
    }

    private async void PenaltyTeam1Clicked()
    {
        Logger.Trace("PenaltyTeam1Clicked");
        PenaltyTeamId = 0;
        //PenaltyPlayerNumbers = ... //todo when playernumbers are implemented
        DialogPenaltyPlayerShow = true;
        await InvokeAsync(() => { StateHasChanged(); });
    }

    private async void PenaltyTeam2Clicked()
    {
        Logger.Trace("PenaltyTeam2Clicked");
        PenaltyTeamId = 1;
        //PenaltyPlayerNumbers = ... //todo when playernumbers are implemented
        DialogPenaltyPlayerShow = true;
        await InvokeAsync(() => { StateHasChanged(); });
    }

    private void RevokePenaltyClicked()
    {   
        Logger.Trace("RevokePenaltyClicked");

        DialogPenaltyRevokeShow = true;
        //await InvokeAsync(() => { StateHasChanged(); });
    }

    private async void ExpandAdvancedControls()
    {
        Logger.Trace("ExpandAvancedControls clicked.");
        HideAdvancedControls = !HideAdvancedControls;
        await InvokeAsync(() => { StateHasChanged(); });
    }

    private async void OnPenaltyPlayerClose(int playerId)
    {
        DialogPenaltyPlayerShow = false;

        if (playerId >= 0)
        {
            Logger.Trace("Modal dialog select player closed. Selected PlayerId/Number: {0}", playerId);
            PenaltyPlayerNumber = playerId;

            // 0 = the penalty is for the team. All others are for the given player number.
            PenaltyList = Match.RulePenaltyList
                            .SelectMany(x => x.Display)
                            .Where(x => x.Language == "EN")
                            .Select(x => x.Text)
                            .ToList();


            //Ask for the penalty
            DialogPenaltyPenaltyShow = true;
        }
        else
        {
            Logger.Trace("Modal dialog select player canceled.");
            PenaltyTeamId = -1; // Reset penaltyId for the next penalty
        }

        await InvokeAsync(() => { StateHasChanged(); });
    }

    /// <summary>
    /// Executed when the dialog to select the penalty closes.
    /// </summary>
    /// <param name="penalty"></param>
    private async void OnPenaltyPenaltyClose(string penalty)
    {
        if (penalty != null && penalty != "")
        {
            Logger.Trace("Modal dialog select penalty closed. Selected penalty: {0}", penalty);

            var languageCode = "EN"; // This will be the users language code when localization is being implemented
            var customPenalty = false;

            // Get the penalty from the rule list
            var penaltyObj = Match.RulePenaltyList.SingleOrDefault(x => x.Display.Any(y => y.Language == languageCode && y.Text == penalty));
            if (penaltyObj == null)
            {
                Logger.Info("The selected penalty is cannot be identified by the text \"" + penalty + "\". Expecting it is a custom penalty. Time penalties need to be added seperately.");
                customPenalty = true;
            }

            // Create the new penalty object
            var newPenalty = new DtoMatchPenalty();
            newPenalty.PlayerNumber = PenaltyPlayerNumber;
            newPenalty.PenaltyTimeStart = Match.MatchMinute;
            newPenalty.Note = string.Format("Penalty \"{0}\" given to player number {1} of {2}", penalty, PenaltyPlayerNumber, (PenaltyTeamId == 0 ? Match.Team1Name : Match.Team2Name));
            newPenalty.TeamId = PenaltyTeamId;
            newPenalty.Timestamp = DateTime.Now;

            if (!customPenalty && penaltyObj != null) // the null check is not required but the null check compiler wants it.
            {
                newPenalty.PenaltyTime = penaltyObj.PenaltySeconds;
                newPenalty.PenaltyName = penaltyObj.Display.Single(x => x.Language == "EN").Text; // The internal name is always the English name
            }
            else
            {
                newPenalty.PenaltyName = penalty;
            }

            // it is a team penalty
            if (PenaltyPlayerNumber == 0)
            {
                newPenalty.Note = string.Format("Penalty \"{0}\" given to team {1}", penalty, (PenaltyTeamId == 0 ? Match.Team1Name : Match.Team2Name));
            }

            // Register the penalty
            await Api.AddMatchPenalty(Match.Id, newPenalty);
        }
        else
        {
            Logger.Trace("Modal dialog select penalty canceled.");
        }

        // Reset all values and hide dialog
        PenaltyPlayerNumber = -1;
        PenaltyTeamId = -1; 
        DialogPenaltyPenaltyShow = false;

        // Reload match details (and UI)
        await LoadMatch();
    }

    /// <summary>
    /// Executed when the yes/no modal dialog closes
    /// </summary>
    /// <param name="result"></param>
    private async void OnYesNoClose(bool result)
    {
        if (result)
        {
            switch (DialogYesNoDangerAction)
            {
                case "CancelMatch":
                    Logger.Info("Running action CancelMatch after confirmation dialog was confirmed.");

                    Logger.Info("Canceling match...");

                    await Api.ControlMatchtimeAsync(Match.Id, "stop");
                    await Api.SetMatchStatusAsync(Match.Id, MatchStatusEnum.Canceled);

                    // Show/hide buttons
                    ButtonDisableStart = true;
                    ButtonCloseMatchDisabled = true;
                    ButtonPreparePeriodDisabled = true;
                    DialogYesNoDangerShow = false;
                    DialogYesNoDangerAction = "";
                    ButtonAllDisabled = true;

                    await InvokeAsync(() => { StateHasChanged(); });
                    break;
                case "RestartMatch":
                    Logger.Info("Running action RestartMatch after confirmation dialog was confirmed.");
                    Logger.Info("Restarting match...");

                    await Api.ControlMatchtimeAsync(Match.Id, "stop");
                    await Api.SetMatchStatusAsync(Match.Id, MatchStatusEnum.Stopped);

                    if (Match.RulePeriodLength.HasValue)
                        Match.TimeLeftSeconds = Match.RulePeriodLength.Value;
                    Match.PeriodCurrent = 1;
                    Match.Penalties = new List<DtoMatchPenalty>();
                    Match.MatchStatus = (int)MatchStatusEnum.ReadyToStart;
                    await Api.SetMatchAsync(Match);
                    var resettedMatch = await Api.GetMatchFullAsync(Match.Id);
                    if (resettedMatch == null)
                    {
                        Logger.Warn("Failed to reset the match! Cancelling the match...");
                        await Api.SetMatchStatusAsync(Match.Id, MatchStatusEnum.Canceled);

                        ButtonDisableStart = true;
                        ButtonCloseMatchDisabled = true;
                        ButtonPreparePeriodDisabled = true;
                        DialogYesNoDangerShow = false;
                        DialogYesNoDangerAction = "";
                        ButtonAllDisabled = true;

                        await InvokeAsync(() => { StateHasChanged(); });
                        return;
                    }
                    Match = resettedMatch;

                    // Show/hide buttons
                    ButtonDisableStart = false;
                    ButtonCloseMatchDisabled = true;
                    ButtonPreparePeriodDisabled = true;
                    DialogYesNoDangerShow = false;
                    DialogYesNoDangerAction = "";

                    await InvokeAsync(() => { StateHasChanged(); });
                    break;
                default:
                    Logger.Warn("The action {0} is not know to be executed after yes/no danger dialog closes.", DialogYesNoDangerAction);
                    break;
            }

            await InvokeAsync(() => { StateHasChanged(); });
        }
    }

    /// <summary>
    /// Executed when the Time Modal Dialog closes.
    /// </summary>
    /// <param name="timeleftSecondsModifier"></param>
    private async void OnTimeClose(int? timeleftSecondsModifier)
    {
        if (timeleftSecondsModifier != null)
        {
            Logger.Debug("OnTimeClose dialog closed with time modifer of {0}", timeleftSecondsModifier);

            var newTimeLeft = Match.TimeLeftSeconds + timeleftSecondsModifier;
            newTimeLeft = (newTimeLeft < 0 ? 0 : newTimeLeft);
            var editMatch = new DtoMatch()
            {
                Id = Match.Id,
                TimeLeftSeconds = newTimeLeft
            };
            await Api.SetMatchAsync(editMatch);

            Match.TimeLeftSeconds = newTimeLeft;
        }

        DialogTimeShow = false;
        await LoadMatch();
    }

    /// <summary>
    /// Exected when the Revoke Penalty Dialog closes
    /// </summary>
    /// <param name="revokedPenalty"></param>
    private async void OnPenaltyRevokeClose(DtoMatchPenalty revokedPenalty)
    {
        if (revokedPenalty != null)
        {
            Logger.Debug("Revoking penalty {0}", revokedPenalty.Id);

            var revokedSrvPenalty = await Api.RevokeMatchPenalty(Match.Id, revokedPenalty.Id, "Revoking \"" + revokedPenalty.Note + "\"");
            var currentPenalty = Match.Penalties.SingleOrDefault(x => x.Id == revokedPenalty.Id);
            if (currentPenalty == null)
            {
                Logger.Warn("Cannot find revoked penalty locally, that was changed before. LocalId: {0}, ServerResponseId: {1}", revokedPenalty.Id, revokedSrvPenalty.Id);
                await LoadMatch();
                return;
            }
            currentPenalty.Revoked = revokedSrvPenalty.Revoked;
            currentPenalty.RevokeNote = revokedSrvPenalty.RevokeNote;

            await LoadMatch();
        }
        DialogPenaltyRevokeShow = false;
    }

    /// <summary>
    /// Executed when the Pause button was clicked
    /// </summary>
    private async void MatchPauseClicked()
    {
        Logger.Trace("PauseMatchClicked");
        await Api.ControlMatchtimeAsync(Match.Id, "stop");

        // Show/hide buttons
        ButtonDisableStart = false;

        await LoadMatchEvents();
    }

    /// <summary>
    /// Executed when the Start button was clicked
    /// </summary>
    private async void MatchStartClicked()
    {
        Logger.Trace("StartMatchClicked");
        // Show/hide buttons
        ButtonDisableStart = true;

        // Update match object to the current status
        Match = await Api.GetMatchFullAsync(Match.Id) ?? Match;

        // Set the LastKnownMatchHash to the current status
        var matchCore = await Api.GetMatchCoreAsync(Match.Id);
        if (matchCore == null)
        {
            Logger.Error("Failed to get MatchCore");
            return;
        }
        LastKnownMatchHash = matchCore.PropertyHash;

        // Send start to the server
        await Api.ControlMatchtimeAsync(Match.Id, "start");

        // Fix the first second gap. It is just a local visual thing.
        if (Match.TimeLeftSeconds > 0)
            Match.TimeLeftSeconds--;

        // Reload match details
        await LoadMatch();
    }

    private void MatchCancelClicked()
    {
        Logger.Trace("MatchCancelClicked");

        DialogYesNoDangerAction = "CancelMatch";
        DialogYesNoDangerShow = true;
    }

    private void MatchRestartClicked()
    {
        Logger.Trace("MatchCancelClicked");

        DialogYesNoDangerAction = "RestartMatch";
        DialogYesNoDangerShow = true;
    }

    private async void MatchSetTimeClicked()
    {
        Logger.Trace("MatchSetTimeClicked");

        DialogTimeShow = true;
        await InvokeAsync(() => { StateHasChanged(); });
    }    

    private async void tmrMatchtime_Elapsed(object? sender, EventArgs e)
    {
        Logger.Trace("Matchtime timer elapsed.");

        // Only run if a match was selected
        if (SelectedMatchId == null || SelectedMatchId == 0)
        {
            Logger.Debug("No match selected. Nothing to do for the matchtimer.");
            return;
        }

        // Get the time left and the hash of all match properties
        var matchCore = await Api.GetMatchCoreAsync(Match.Id);

        // If the core value query failed, cancel.
        if (matchCore == null) {
            Logger.Error("Failed to get MatchCore");
            return;
        }

        // Update match object in case the hash is different
        if (LastKnownMatchHash != matchCore.PropertyHash)
        {
            Logger.Info("New Hash is different. Refreshing all Match infos...");
            var newMatchInfo = await Api.GetMatchAsync(Match.Id);
            if (newMatchInfo != null) {
                Logger.Debug("Updated Match infos.");

                // Update only the fields but not the whole Match object to do not flush the rules
                Match.PeriodCurrent = newMatchInfo.PeriodCurrent;
                Match.RulePeriodCount = newMatchInfo.RulePeriodCount;
                Match.MatchStatus = newMatchInfo.MatchStatus;
                Match.TimeLeftSeconds = newMatchInfo.TimeLeftSeconds;
                Match.Team1Score = newMatchInfo.Team1Score;
                Match.Team2Score = newMatchInfo.Team2Score;

                LastKnownMatchHash = matchCore.PropertyHash;
            }            
            await LoadMatchEvents();
        }

        // If local timer says, time is over check verify before stopping
        if (Match.TimeLeftSeconds == 0)
        {
            // Set the current time left to the server data
            Match.TimeLeftSeconds = matchCore.TimeLeftSeconds;

            // Stop Timer only if the Server based timer is done.
            if (Match.TimeLeftSeconds == 0)
            {
                Logger.Info("Time of match {0} is over.", Match.Id);
                tmrMatchtime.Stop();

                // If this is not the last period, show the start button to start the next period
                if (Match.PeriodCurrent != Match.RulePeriodCount)
                {
                    Logger.Debug("Not-the-last period is over.");
                    ButtonDisableStart = false;
                    ButtonPreparePeriodDisabled = false;
                    ButtonCloseMatchDisabled = true;
                }
                else
                {
                    Logger.Debug("Last period is over.");
                    ButtonDisableStart = true;
                    ButtonPreparePeriodDisabled = true;
                    ButtonCloseMatchDisabled = false;
                }

                await LoadMatchEvents();
            }
        }
        else // update local timer
        {
            //To count the seconds more smoothly, only correct the seconds, if the diff is more than 1 second
            var serverTimeLeft = matchCore.TimeLeftSeconds;
            if (Match.TimeLeftSeconds - serverTimeLeft > 1 ||
                Match.TimeLeftSeconds - serverTimeLeft < 1)
            {
                Match.TimeLeftSeconds = serverTimeLeft;
            }
            else if (Match.TimeLeftSeconds > 0)
            {                
                Match.TimeLeftSeconds--;
            }
        }
        await InvokeAsync(() => { StateHasChanged(); });
    }

    protected override async Task OnParametersSetAsync()
    {
        Logger.Trace("Reloading the page.");
        await LoadMatch();

        if (Match.MatchStatus == (int)MatchStatusEnum.Canceled || Match.MatchStatus == (int)MatchStatusEnum.Ended ||Match.MatchStatus == (int)MatchStatusEnum.Closed)
        {
            ButtonAllDisabled = true;
        }
        else {
            if (!tmrMatchtime.Enabled)
                tmrMatchtime.Start();
        }

        await base.OnParametersSetAsync();
    }

    protected override async Task OnInitializedAsync()
    {
        Logger.Trace("Initializing the page");
        if (SelectedMatchId == null)
        {
            Logger.Debug("No match selected.");
            await LoadMatchList();
        }
        else
        {
            Logger.Debug("Match {0} selected.", SelectedMatchId);
            await LoadMatch();

            if (Match.MatchStatus == (int)MatchStatusEnum.Canceled || Match.MatchStatus == (int)MatchStatusEnum.Ended ||Match.MatchStatus == (int)MatchStatusEnum.Closed)
            {
                ButtonAllDisabled = true;
                return;
            }
        }

        // Needs to be initialized at the load of the page to also show running matches
        if (tmrMatchtimeElapsedRegistered == false)
        {
            tmrMatchtime.Interval = 1000;
            tmrMatchtime.Elapsed += tmrMatchtime_Elapsed;
            tmrMatchtimeElapsedRegistered = true;
        }

        tmrMatchtime.Start();

        await InvokeAsync(() => { StateHasChanged(); });
    }


    /// <summary>
    /// Checks if the current match should be shown on a display and sets the setting
    /// </summary>
    private async Task InitializeDisplay()
    {
        //Check if the current match has display(s) to show the match on
        if (Match.DeviceIds.Count > 0)
        {
            foreach (var aDev in Match.DeviceIds)
            {
                Logger.Debug("Setting display {0} to show match id {1} because it is listed as the display device.", aDev, SelectedMatchId);
                var devSet = new DtoDeviceSetting(aDev, "matchid", (SelectedMatchId ?? 0).ToString());
                await Api.SetDeviceSettingAsync(aDev, devSet);

                await Api.SetDeviceCommand(aDev, "loadmatch", "");
            }
        }
    }

    private async Task LoadMatchList()
    {
        Logger.Trace("Loading MatchList");
        var matchList = await Api.GetMatchListAsync();
        if (matchList.Count == 0)
        {
            Logger.Debug("No matches in matchlist");

            //Create emtpy list
            MatchList = new List<DtoMatch>();
            return;
        }
        MatchList = matchList.Where(x => x.MatchStatus != (int)MatchStatusEnum.Undefined && x.MatchStatus != (int)MatchStatusEnum.Canceled && x.MatchStatus != (int)MatchStatusEnum.Closed).ToList() ?? new List<DtoMatch>();
    }

    private async Task LoadMatch()
    {
        if (SelectedMatchId == null)
        {
            Logger.Debug("No match selected to load.");
            return;
        }

        Logger.Debug("Loading match {0}", SelectedMatchId);

        Match = (await Api.GetMatchFullAsync(SelectedMatchId.Value)) ?? new DtoMatch() { Id = 0 };
        if (Match.Id == 0)
            return;

        if (Match.MatchStatus >= (int)LeDi.Shared.Enum.MatchStatusEnum.Running)
        {
            ButtonDisableStart = true;
        }
        else
        {
            ButtonDisableStart = false;
        }

        // Update the Match Events
        await LoadMatchEvents();

        // Set the Displays, that should show the Match
        await InitializeDisplay();

        await InvokeAsync(() => { StateHasChanged(); });
    }

    private async Task LoadMatchEvents()
    {
        if (SelectedMatchId == null)
        {
            Logger.Debug("No match selected to load match events for.");
            return;
        }

        Logger.Debug("Loading match events for {0}.", SelectedMatchId);

        MatchEventList = await Api.GetMatchEvents(SelectedMatchId.Value);

        await InvokeAsync(() => { StateHasChanged(); });
    }

    /// <summary>
    /// Executed, when the prepare period button is clicked.
    /// </summary>
    private async Task MatchPreparePeriodClicked()
    {
        Logger.Trace("PreparePeriod clicked.");

        if (Match == null)
            return;

        if (SelectedMatchId == null)
            return;

        // only if the current period is over
        if (Match.TimeLeftSeconds != 0)
        {
            Logger.Warn("Current period is not over.");
            ButtonPreparePeriodDisabled = true;
            return;
        }

        //Check if there is another period
        if (Match.PeriodCurrent < Match.RulePeriodCount)
        {
            ButtonPreparePeriodDisabled = true;

            await Api.SetMatchPeriodNext(SelectedMatchId.Value);
            await LoadMatch();

            await InvokeAsync(() => { StateHasChanged(); });
        }
    }

    /// <summary>
    /// Executed when the close button is clicked
    /// </summary>
    private async Task MatchCloseClicked()
    {
        Logger.Trace("CloseMatch clicked");

        if (Match == null)
            return;

        if (SelectedMatchId == null)
            return;

        // The last period must be over
        if (Match.PeriodCurrent != Match.RulePeriodCount && Match.TimeLeftSeconds == 0)
            return;

        await Api.SetMatchStatusAsync(Match.Id, (int)MatchStatusEnum.Closed);
        ButtonCloseMatchDisabled = true;
        ButtonAllDisabled = true;

        // Go back to the match control page
        SelectedMatchId = null;
        await LoadMatchList();
        NavigationManager.NavigateTo("matchcontrol");
    }

    /// <summary>
    /// Executed when the Set Display button is clicked
    /// </summary>
    /// <returns></returns>
    private async Task SetDisplayClicked()
    {
        Logger.Trace("SetDisplay clicked");

        if (SelectedMatchId != null)
        {
            var deviceList = await Api.GetDeviceAsync();
            if (deviceList== null)
            {
                Logger.Warn("No Devices configured or cannot get devicelist from server.");
                return;
            }

            DeviceList = deviceList;
            DialogDeviceShow = true;
        }
        else
        {
            Logger.Warn("No match selected");
        }
    }

    /// <summary>
    /// Executed after the DeviceDialog closes
    /// </summary>
    /// <param name="dev"></param>
    /// <returns></returns>
    private async Task OnDisplayClose(DtoDevice dev)
    {
        DialogDeviceShow = false;
        await InvokeAsync(() => { StateHasChanged(); });

        Logger.Debug("Setting display {0} to show match id {1}", dev.DeviceId, SelectedMatchId);
        var devSet = new DtoDeviceSetting(dev.DeviceId, "matchid", (SelectedMatchId ?? 0).ToString());
        await Api.SetDeviceSettingAsync(dev.DeviceId, devSet);

        await Api.SetDeviceCommand(dev.DeviceId, "loadmatch", "");
    }
}